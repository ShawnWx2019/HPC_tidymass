---
title: "HPC_tidymassæµç¨‹å¼€å‘"
author: "Shawn"
date: "`r Sys.Date()`"
format: html
editor: visual
---

<center>

<font color=salmon size=2pt> ğŸ¡Zhang Lab, `r format(Sys.time(), '%B, %Y')` ğŸ¡</font>

<font color=green size=2pt> ğŸ”¬Multi-omics research center, HENU, Kaifeng, Henan ğŸ”¬</font>

<font color=green size=2pt> ğŸ”¬State Key Laboratory of Crop Stress Adaption and Improvement, HENU, Kaifeng, Henan ğŸ”¬</font>

</center>

# éœ€è¦æ­å»ºçš„ç¯å¢ƒï¼š

é¦–å…ˆè”ç³»ç®¡ç†å‘˜å¼€é€šlinuxè´¦æˆ·ã€‚ç„¶åå¹¶å°†è´¦æˆ·æ·»åŠ åˆ°`bio`å’Œ`docker`ç”¨æˆ·ç»„ã€‚`bio`è´¦æˆ·æ˜¯æˆ‘ä»¬ä¸Šä¼ åŸå§‹æ•°æ®çš„è´¦æˆ·ï¼Œåœ¨æ•°æ®æ ¼å¼è½¬æ¢çš„æ—¶å€™éœ€è¦ç”¨åˆ°`docker`,åœ¨linuxç³»ç»Ÿä¸‹ï¼Œåªæœ‰`root`è´¦å·å¯ä»¥ä½¿ç”¨`docker`ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª`docker`çš„ç”¨æˆ·ç»„ï¼Œå°†éœ€è¦ä½¿ç”¨`tidymass`æµç¨‹è´¦å·çº³å…¥`docker group`ã€‚\
æ£€æŸ¥æ˜¯å¦å±äº`docker` ç”¨æˆ·ç»„å¯ä»¥é€šè¿‡åœ¨ç»ˆç«¯è¾“å…¥`groups`è¿›è¡Œç»„åˆ«æŸ¥çœ‹ï¼š

```{r eval=FALSE}
shawn@bio-Super-Server:~$ groups
root sudo docker bio teacher
```

å…¶æ¬¡éœ€è¦å®‰è£…`tidyvers`,`tidymass`ä»¥åŠæˆ‘å†™çš„`MDAtoolkits`å’Œ`IMOtoolkits`åŒ…ã€‚åŒæ ·é€šè¿‡ä¸‹åˆ—ä»£ç æŸ¥çœ‹ä¾èµ–åŒ…æ˜¯å¦å®‰è£…å¥½ã€‚

```{r eval=FALSE}
shawn@bio-Super-Server:~$ R ## ç»ˆç«¯è¾“å…¥Rå›è½¦

R version 4.1.2 (2021-11-01) -- "Bird Hippie"
Copyright (C) 2021 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

##> åŠ è½½åŒ…ï¼Œæ²¡æœ‰ERRORæŠ¥é”™è¯´æ˜è£…å¥½äº†ã€‚
library(tidymass)
library(tidyverse)
library(MDAtoolkits)
library(IMOtoolkits)
```

ç¯å¢ƒåˆå§‹åŒ–: é¦–å…ˆé€šè¿‡ä¸‹åˆ—å‘½ä»¤åˆ›å»ºè„šæœ¬å­˜æ”¾è·¯å¾„

```{r eval=FALSE}
cd ## å›åˆ°å®¶ç›®å½•
##> ç¬¬ä¸€æ­¥ åˆ›å»ºè„šæœ¬å­˜æ”¾è·¯å¾„
mkdir -p /01.src/02.script/02.Tidymass
##> ç¬¬äºŒæ­¥ é€šè¿‡sftpå°†è„šæœ¬æ–‡ä»¶ä¸Šä¼ åˆ°è¯¥è·¯å¾„
##> ç¬¬ä¸‰æ­¥ è¾“å…¥ä¸‹é¢ä»£ç æŠŠè„šæœ¬å†™è¿›ç¯å¢ƒå˜é‡ï¼Œæ·»åŠ alias
echo 'alias peakpicking="Rscript ~/01.src/02.script/02.Tidymass/02.PeakPicking.R"' >> ~/.bash_alias
echo "alias ms1convert='bash ~/01.src/02.script/02.Tidymass/01.msconvert.sh'">> ~/.bash_alias
echo "alias ms2convert='bash ~/01.src/02.script/02.Tidymass/03.ms2convert.sh'" >> ~/.bash_alias
echo "alias runTidymass='bash ~/01.src/02.script/02.Tidymass/runTidymass.sh'" >> ~/.bash_alias
echo "alias datacleaning='Rscript ~/01.src/02.script/02.Tidymass/04.dataclean.R'" >> ~/.bash_alias
echo "alias feature_anno='Rscript ~/01.src/02.script/02.Tidymass/05.feature_anno'" >> ~/.bash_alias
echo "alias feature_downstream='Rscript ~/01.src/02.script/02.Tidymass/06.feature_downstream.R'" >> ~/.bash_alias
echo "source ~/.bash_alias" >> ~/.bashrc
source ~/.bashrc
```

è‡³æ­¤åˆ†æç¯å¢ƒæ­å»ºå®Œæ¯•ã€‚

# æ ‡å‡†æµç¨‹ï¼š

| æ­¥éª¤ | æè¿°                         | è„šæœ¬åç§°                 | çŠ¶æ€   | æ”¹è¿›æ–¹å‘                       |
|---------------|---------------|---------------|---------------|---------------|
| 1    | ä¸‹æœºæ•°æ®è½¬æ¢ä¸ºå¼€æºæ ¼å¼.mzXML | 01.msconvert.sh          | <font color=green>æ­£å¸¸</font>   | æ•ˆç‡è¾ƒä½ï¼Œä¼˜åŒ–å¹¶è¡Œ             |
| 2    | ä¸‹æœºæ•°æ®è½¬æ¢ä¸ºå¼€æºæ ¼å¼.mgf   | 03.ms2convert.sh         | <font color=green>æ­£å¸¸</font>   | æ•ˆç‡è¾ƒä½ï¼Œä¼˜åŒ–å¹¶è¡Œ             |
| 3    | featureæå–                  | 02.PeakPicking.R         | <font color=green>æ­£å¸¸</font>   | æ—                              |
| 4    | æ•°æ®æ¸…æ´—                     | 04.dataclean.R           | <font color=green>æ­£å¸¸</font>   | ç›®å‰æ²¡æœ‰é‡åˆ°bugï¼Œä¾æ®é¡¹ç›®æ”¹è¿›  |
| 5    | åŒ–åˆç‰©æ³¨é‡Šï¼Œåˆ†ç±»             | 05.feature_anno.R        | <font color=blue>å¾…ä¼˜åŒ–</font> | æé«˜MS1æœåº“æ•ˆç‡ï¼Œè”ç³»Dr. Shen  |
| 6    | ä¸‹æ¸¸åˆ†æ                     | 06.feature_downstream.sh | <font color=blue>å¾…ä¼˜åŒ–</font> | ç›®å‰åŒ…æ‹¬å·®å¼‚åˆ†æï¼Œå¯Œé›†åˆ†æ     |
| 7    | æŠ¥å‘Šç”Ÿäº§                     | 07.report.R              | <font color=red>å¾…å¯åŠ¨</font> | ç¡®å®šäº†ä¸‹æ¸¸åˆ†æå¯¹è±¡åè‡ªåŠ¨åŒ–ç”Ÿæˆ |
| 8    | ä¸€é”®æµç¨‹                     | runTidymass.sh    |<font color=purple>å¼€å‘ä¸­</font> |æ–­ç‚¹ç»§ç»­çš„åˆ¤æ–­
| 9    | shinyappå¼€å‘  | runTidymass_shiny|<font color=purple>æœªå¯åŠ¨</font> |



## æ ‡å‡†æµç¨‹å›¾ï¼š

ä¸‹é¢æ‰€è¯´çš„å¯¹è±¡ä¸º`tidymass`æ„å»ºçš„`S4`å¯¹è±¡,è¢«ç§°ä¸º`massdataset`ï¼Œå…¶ä¸­åŒ…å«äº†æ‰€æœ‰`feature`çš„è´¨è°±ä¿¡æ¯ã€è¡¨è¾¾æ°´å¹³ã€æµ‹è¯•ææ–™ä¿¡æ¯ç­‰ã€‚

```{mermaid}
flowchart TB
  A[ä¸‹æœºåŸå§‹æ•°æ®] -- 01.msconvert.sh --> B[å¼€æºæ ¼å¼.mzXML]
  A[ä¸‹æœºåŸå§‹æ•°æ®.raw] -- 03.ms2convert.sh --> C[å¼€æºæ ¼å¼.mgf]
  B[å¼€æºæ ¼å¼.mzXML] -- 02.PeakPicking.R --> D[åŸå§‹å¯¹è±¡]
  D[åˆå§‹å¯¹è±¡] -- 04.dataclean.R --> E[è¿‡æ»¤åå¯¹è±¡]
  E[è¿‡æ»¤åå¯¹è±¡] -- 05.feature_anno.R --> F[æ³¨é‡Šåå¯¹è±¡]
  C[å¼€æºæ ¼å¼.mgf] -- 05.feature_anno.R --> F[æ³¨é‡Šåå¯¹è±¡]
  F[æ³¨é‡Šåå¯¹è±¡] --06.feature_downstream.sh --> G[ä¸‹æ¸¸åˆ†æ]
  G[ä¸‹æ¸¸åˆ†æ] --07.report.R --> H[ç”ŸæˆæŠ¥å‘Š]
```

```{r,eval=FALSE}
-------------------- 
massdataset version: 1.0.5 
-------------------- 
1.expression_data:[ 5105 x 244 data.frame]
2.sample_info:[ 244 x 4 data.frame]
3.variable_info:[ 5105 x 3 data.frame]
4.sample_info_note:[ 4 x 2 data.frame]
5.variable_info_note:[ 3 x 2 data.frame]
6.ms2_data:[ 0 variables x 0 MS2 spectra]
-------------------- 
Processing information (extract_process_info())
2 processings in total
create_mass_dataset ---------- 
      Package         Function.used                Time
1 massdataset create_mass_dataset() 2022-12-06 08:50:25
process_data ---------- 
        Package Function.used                Time
1 massprocesser  process_data 2022-12-06 08:32:23

```

## ä½¿ç”¨æ–¹æ³•

### æ•°æ®å‡†å¤‡

- åœ¨å®éªŒå‡†å¤‡å‰ï¼Œå…ˆå¯¹æ ·å“è¿›è¡Œç¼–å·åŒ¹é…ï¼Œæ ·å“ç¼–å·ç»Ÿä¸€ä¸º`S_0001 --> S_1000`ç±»å‹ï¼Œæ³¨æ„è¿™é‡Œéœ€è¦ç”¨`0`è¡¥é½,å› ä¸ºlinuxç³»ç»Ÿä¸‹é»˜è®¤æŒ‰æ–‡ä»¶åæ’åºï¼Œå¦‚æœä¸åŠ `pad`é¡ºåºä¼šæ˜¯`S_1 S_10 S_11 .... S_2 S_20 S_21...`é€ æˆä¸å¿…è¦çš„é”™è¯¯ã€‚`pad`æ•°é‡æ ¹æ®æ ·æœ¬é‡çš„å¤§å°è¡¥å……ï¼Œä¸‰ä½æ•°è¡¥å……ä¸¤ä½ï¼Œå››ä½æ•°è¡¥å……3ä½ã€‚åŒæ ·`QC`ç¼–å·ä¸º`QC_01 ... QC_20`;

- æ–‡ä»¶ç»“æ„,å¯¹äºæ­£è´Ÿè°±åŒæ—¶é‡‡çš„é¡¹ç›®ï¼Œå°†æ‰€æœ‰`.raw`æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ï¼Œç”¨`bio`è´¦å·æ‹·è´åˆ°`/home/data/public/02.rawdata/03.Metabolomics/kq-1`è·¯å¾„ä¸‹ã€‚

- æ–‡ä»¶ç»“æ„,å¯¹äºæ­£è´Ÿè°±åˆ†å¼€é‡‡çš„é¡¹ç›®ï¼Œé¦–å…ˆæ–°å»ºä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸€ä¸ªä¸º`NEG`,å¦ä¸€ä¸ªä½`POS`,åˆ†åˆ«å°†æ­£è´Ÿè°±çš„ç»“æœæ”¾å…¥å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œç„¶åæ‹·è´ã€‚

```{r eval=FALSE}
shawn@bio-Super-Server:~/public/02.rawdata/03.Metabolomics$ tree -d kq-1
kq-1
|___ NEG
|___ POS
```

å¿…é¡»ä¸¥æ ¼æŒ‰ç…§å‘½åè§„åˆ™å’Œæ–‡ä»¶æ ¼å¼å‡†å¤‡ï¼Œ`QC, S, NEG, POS`å‡ä¸ºå¤§å†™ï¼Œ`_`ä¸ºä¸‹åˆ’çº¿ã€‚


### è„šæœ¬è¿è¡Œ

ç›®å‰ä¸€é”®è¿è¡Œè„šæœ¬å·²ç»å¼€å‘åˆ°å…¨éƒ¨å®Œæˆ`1-4`æ­¥éª¤,å¹¶ä¸”å…·æœ‰æ–­ç‚¹ç»­è·‘çš„åŠŸèƒ½ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡`runTidymass.sh`è¿›è¡Œ`1-4`æ­¥éª¤ã€‚

```{r eval=FALSE}
/home/data/shawn/01.src/02.script/02.Tidymass/runTidymass.sh: option requires an argument -- h
Tidymass pipeline part1. Date transform and peak picking

@Usage:
-------------------------------
runTidymass [-i input] [-t type] [-c column]
-------------------------------
@Author Shawn Wang (shawnwang2016@126.com)
-------------------------------
@Date Tus Feb 09, 2023
-------------------------------
@Version V.0.0.0.99 beta
-------------------------------
@Description
-------------------------------
[-i]:input,   The file path of .raw data
[-t]:type,    The type of ion model, 1: NEG+POS in one file, 2: NEG and POS in differnet files
[-c]:column,  rp or hilic
-------------------------------
```

ç›®å‰éœ€è¦çš„å‚æ•°ï¼š

<font color=green>**-i | input**</font>ï¼šåŸå§‹æ•°æ®å­˜æ”¾è·¯å¾„ï¼Œä¸€èˆ¬ä¸ºåœ¨`/home/data/public/02.rawdata/03.Metabolomics/xxx`ã€‚  

<font color=green>**-t | type**</font>ï¼šé‡‡é›†æ¨¡å¼ï¼Œ1ï¼šä¸ºæ­£è´Ÿè°±åŒæ—¶é‡‡é›†ï¼Œ2ï¼šæ­£è´Ÿè°±åˆ†å¼€é‡‡é›†ã€‚

<font color=green>**-c | column**</font>ï¼šæŸ±å­å‹å·ï¼Œrp è¿˜æ˜¯ hilicã€‚

### è¾“å‡ºç»“æœæ–‡ä»¶ç»“æ„

```{r eval=FALSE}
shawn@bio-Super-Server:~/02.project/13.kq1$ tree -d test/
test/
â””â”€â”€ working_dir
    â”œâ”€â”€ 01.data
    â”‚Â Â  â””â”€â”€ rawdata
    â”‚Â Â      â”œâ”€â”€ NEG
    â”‚Â Â      â”‚Â Â  â”œâ”€â”€ QC
    â”‚Â Â      â”‚Â Â  â””â”€â”€ Subject
    â”‚Â Â      â””â”€â”€ POS
    â”‚Â Â          â”œâ”€â”€ QC
    â”‚Â Â          â””â”€â”€ Subject
    â”œâ”€â”€ 02.progress
    â”‚Â Â  â”œâ”€â”€ Data_cleaning
    â”‚Â Â  â”œâ”€â”€ annotation
    â”‚Â Â  â”œâ”€â”€ peak_picking
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ NEG
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ Result
    â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ intermediate_data
    â”‚Â Â  â”‚Â Â  â””â”€â”€ POS
    â”‚Â Â  â”‚Â Â      â””â”€â”€ Result
    â”‚Â Â  â”‚Â Â          â””â”€â”€ intermediate_data
    â”‚Â Â  â””â”€â”€ transform
    â”‚Â Â      â”œâ”€â”€ MS1
    â”‚Â Â      â”‚Â Â  â”œâ”€â”€ NEG
    â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ QC
    â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ Subject
    â”‚Â Â      â”‚Â Â  â””â”€â”€ POS
    â”‚Â Â      â”‚Â Â      â”œâ”€â”€ QC
    â”‚Â Â      â”‚Â Â      â””â”€â”€ Subject
    â”‚Â Â      â””â”€â”€ MS2
    â”‚Â Â          â”œâ”€â”€ NEG
    â”‚Â Â          â”‚Â Â  â”œâ”€â”€ QC
    â”‚Â Â          â”‚Â Â  â””â”€â”€ Subject
    â”‚Â Â          â””â”€â”€ POS
    â”‚Â Â              â”œâ”€â”€ QC
    â”‚Â Â              â””â”€â”€ Subject
    â””â”€â”€ 03.result
```

# ç›®å‰çš„é—®é¢˜ï¼š

Q1. æ ¼å¼è½¬æ¢é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œç›®å‰ææ¸…æ¥šçš„é—®é¢˜æ¥æºæ˜¯é€šè¿‡`docker`è¿è¡Œ`msconvert`ä¸åŒåŒæ—¶å¤„ç†å¤šä¸ªåŸå§‹æ•°æ®æ–‡ä»¶ã€‚  

M1. å°è¯•å¹¶è¡Œï¼Œå‡†å¤‡å¥½åŸå§‹æ•°æ®åè¿­ä»£ï¼Œä½†å¯èƒ½å¼€å¤§é‡è™šæ‹Ÿæœºå¯¹æœåŠ¡å™¨è´Ÿè½½è¦æ±‚è¾ƒé«˜ã€‚ç¬¬äºŒä¸ªæ–¹æ¡ˆæ˜¯åœ¨windowsä¸‹ç›´æ¥ç”¨`msconvert`è½¬æ¢ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥åŒæ—¶è½¬æ¢å¤§é‡åŸå§‹æ•°æ®ã€‚

Q2. æ­£è´Ÿè°±åŒæ—¶é‡‡é›†çš„æ•°æ®ç”¨tidymassæå³°ç»“æœåˆå¾ˆå¤§é—®é¢˜ã€‚ç›®å‰åŸå› ä¸æ˜ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ç»“æœ

# è®¡åˆ’

1. æœ¬å‘¨å®Œæˆä¸‹æ¸¸åˆ†æè„šæœ¬è°ƒè¯•ã€‚  

2. ä¸‹å‘¨3ä¹‹å‰å®Œæˆä¸€é”®è„šæœ¬æµç¨‹çš„è°ƒè¯•ï¼ŒæŠ•å…¥ä½¿ç”¨ã€‚  

3. 5å‘¨å†…å®Œæˆshinyappå¼€å‘ï¼Œæ–‡ç« å†™ä½œã€‚

